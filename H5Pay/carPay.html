<!--问题：在添加银行卡页面是否判断生成订单成功失败！-->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>快捷支付</title>
		<script type="text/javascript" src="js/jquery-3.2.1.js" ></script>
		<link rel="stylesheet" href="css/style.css" />
		<style>
			.btns{margin-top:30px;}
			.con_bott{width:100%;text-align: center;position: relative;top:60px;}
			.spe input{width:38%;}
			.spe .msgs{width:30%;cursor: pointer;}
			#loader8 { 
			  position: relative;
			  top:-300px;
			  left:50%;  
			  margin-left:-20px;  
			  border-top: 8px solid rgba(0, 0, 0, 0.2);     
			  border-right: 8px solid rgba(0, 0, 0, 0.2);     
			  border-bottom: 8px solid rgba(0, 0, 0, 0.2);     
			  border-left: 8px solid rgba(0, 0, 0, 0.5);     
			  -webkit-animation: load8 1.1s infinite linear;     
			  animation: load8 1.1s infinite linear;     
			}     
			#loader8,#loader8:after {     
			  border-radius: 50%;     
			  width: 20px;     
			  height: 20px;     
			}     
			@-webkit-keyframes load8 {     
			  0% {     
			    -webkit-transform: rotate(0deg);     
			    transform: rotate(0deg);     
			  }     
			  100% {     
			    -webkit-transform: rotate(360deg);     
			    transform: rotate(360deg);     
			  }     
			}     
			@keyframes load8 {     
			  0% {     
			    -webkit-transform: rotate(0deg);     
			    transform: rotate(0deg);     
			  }     
			  100% {     
			    -webkit-transform: rotate(360deg);     
			    transform: rotate(360deg);     
			  }     
			}     
		</style>
	</head>
	<body>
		<div class="container">
			<section class="con_main">
				<header class="con_main_tit">
					<div class="con_main_tit_tip">付款给业务交易账户——交易账户</div>
					<div class="con_main_tit_money">
						<span class="money" id="money"></span>
						<span>元</span>
					</div>
					<span class="up">
						<img src="img/up.png" />
					</span>
					<span class="down">
						<img src="img/down.png" />
					</span>
				</header>
				<section class="con_main_more">
					<div class="more_tit">
						<div class="more_tit_name">商品名称</div>
						<div class="more_tit_exp" id="pro_name">银联支付</div>
					</div>
					<div class="more_main">
						<div class="more_main_name">订单号</div>
						<div class="more_main_exp" id="orders"></div>
					</div>
				</section>
				<section class="con_main_carId" id="bank_more">
					<div class="more_main more_main1">
						<img id="logo" src="img/ICBC.png" />
						<span class="bank_name"><span id="cardBank"></span><span id="carType">储蓄卡</span></span>
						<span class="last">(<span class="last_id last_id_tit"></span>)</span>
						<!--<span class="more_bank">&gt;</span>-->
					</div>
				</section>
				<section class="msg_tit">
				
				</section>
				<section class="msg_main">
					<section class="spe">
						<span>验证码</span>
						<input type="text" placeholder="输入验证码" id="yzm_tex" />
						<span class="msgs msgFirst">获取验证码</span>
						<span class="msgs msgRepeat" style="color: #999;display: none;"><span id="repeatSub">重新发送</span><span>(</span><span id="times">60</span><span>s</span><span>)</span></span>
					</section>
				</section>
				<section class="agree">
					<input type="checkbox" value="1" id="agrees" />
					<span>同意</span>
					<div class="xieyi">《服务协议》</div>
				</section>
				<section class="btns">
					<div class="pay" id="pay">立即支付</div>
				</section>
			</section> 
			<footer class="con_bott">
				<section class="con_bott_tit">
					<span class="bott_tit_img"><img src="img/logo.png" /></span><span class="bott_tit_tex">银联快捷支付</span>
				</section>
				<section class="con_bott_msg">本服务由云时代提供技术支持</section>
				<section class="con_bott_call">云时代客服电话: <span>400-873-2911</span></section>
			</footer>
			<div class="modal">
	            <div class="modal-dialog">
		            <div class="modal-content">
			            <form id="buy-form">
			                <div class="tips" id="error"></div>
			            </form>
					</div>
				 </div>
		     </div>
		     <div class="agree_mod">
		     	<div class="agree_con">
		     		<div class="agree_con_tit">
		     			<span>服务协议</span>
		     			<span id="yes" class="yes">同意</span>
		     		</div>
		     		<div class="agree_con_main">
		     			<p>
		     				一、概述
		     			</p>
		     			<p>
		     				1、银联支付《一键支付用户服务协议》（以下简称“本协议”）是您自愿与银联支付有限公司（以下简称“银联支付”）就银联一键支付服务（以下简称“本服务”）的使用所签订的有效合约。您通过网络页面点击确认本协议或以其他方式选择接受本协议，即表示您与银联支付已达成协议并同意接受本协议的全部约定内容。
		     			</p>
		     			<p>
		     				2、在您接受本协议之前，请您仔细阅读本协议的全部内容，如您不同意接受本协议的任意内容，或者无法准确理解相关条款含义的，请不要进行后续操作。如果您对本协议的条款有疑问的，请通过银联支付客服渠道进行询问（银联支付客服电话为400-873-2911），银联支付将向您解释条款内容。
		     			</p>
		     			<p>
		     				3、您同意，银联支付有权随时对本协议内容进行单方面的变更，无需另行单独通知您；若您在本协议内容公告变更生效后继续使用本服务的，表示您已充分阅读、理解并接受变更修改后的协议内容，也将遵循变更修改后的协议内容使用本服务；若您不同意变更修改后的协议内容，您应在变更生效前停止使用本服务。
		     			</p>
		     			<p>
		     				二、双方权利义务
		     			</p>
		     			<p>
		     				1、您应确保您在使用本服务时的银行卡为您本人的银行卡，确保您使用银行卡的行为合法、有效，未侵犯任何第三方合法权益；否则因此造成银联支付、商户、持卡人损失的，您应负责赔偿并承担全部法律责任。
		     			</p>
		     			<p>
		     				2、您应确保开通本服务所提供的手机号码为本人所有，并授权银联支付可以通过第三方渠道对您所提供手机号码的真实性、有效性进行核实。
		     			</p>
		     			<p>
		     				3、您应妥善保管银行卡、卡号、密码、发卡行预留的手机号码等与银行卡有关的一切信息。如您遗失或泄漏前述信息，您应及时通知发卡行及/或银联支付，以减少可能发生的损失。无论是否已通知发卡行及/或银联支付，因您的原因所致损失需由您自行承担。
		     			</p>
		     			<p>
		     				4、您在使用本服务时，应当认真确认交易信息，包括且不限于商品名称、数量、金额等，并按银联支付业务流程发出约定的指令。您认可和同意：您发出的指令不可撤回或撤销，银联支付一旦根据您的指令委托银行或第三方从银行卡中划扣资金给收款人，您不应以非本人意愿交易或其他任何原因要求银联支付退款或承担其他责任。</p>
		     			<p>
		     				5、您不应将本服务用于任何违反国家相关法律法规或本协议的目的。
		     			</p>
		     			<p>
		     				6、您在对使用本服务过程中发出指令的真实性及有效性承担全部责任；您承诺，银联支付依照您的指令进行操作的一切风险由您承担。
		     			</p>
		     			<p>
		     			    7、您认可并以银联支付系统平台记录的数据为准。
		     			</p>
		     			<p>
		     				8、同时您授权银联支付有权留存您在银联支付网站填写的相应信息，以供后续向您持续性地提供相应服务（包括但不限于将本信息用于向您推广、提供其他更加优质的产品或服务）。
		     			</p>
		     			<p>
		     				9、出现下列情况之一的，银联支付有权立即终止您使用银联支付相关服务而无需承担任何责任：
		     			</p>
		     			<p>
		     			       （1）违反本协议的约定；
		     			</p>
		     			<p>
		     			       （2）将本服务用于非法目的；
		     			</p>
		     			<p>
		     				（3）违反银联支付/或其他关联公司网站的条款、协议、规则、通告等相关规定，而被上述任一网站终止提供服务的；
		     			</p>
		     			<p>
		     				（4）银联支付认为向您提供本服务存在风险的；
		     			</p>
		     			<p>
		     				（5）您的银行卡无效、有效期届满或注销（如有）。
		     			</p>
		     			<p>
		     				10、若您未违反本协议约定且因不能归责于您的原因，造成银行卡内资金通过本服务出现损失，且您未从中获益的，您可向银联支付申请补偿。您应在知悉资金发生损失后及时通知银联支付并按要求提交相关的申请材料和证明文件，您同意，您能否得到补偿及具体金额取决于银联支付自身独立的判断，银联支付承诺不会因此损害您的合法权益。
		     			</p>
		     			<p>
		     				11、您同意并认可银联支付最终的补偿行为并不代表前述资金损失应归责于银联支付，亦不代表银联支付须为此承担其他任何责任。您同意，银联支付在向您支付补偿的同时，即刻取得您可能或确实存在的就前述资金损失而产生的对第三方的所有债权及其他权利，包括但不限于就上述债权向第三方追偿的权利，且您不再就上述已经让渡给银联支付的债权向该第三方主张任何权利，亦不再就资金损失向银联支付主张任何权利。
		     			</p>
		     			<p>
		     				12、此外，在接受补偿的同时或之后，您从其它渠道挽回了前述资金损失的，或有新证据证明您涉嫌欺诈的，或者发生您应当自行承担责任的其他情形，您应在第一时间返还银联支付向您支付的补偿款项，否则银联支付有权向您进行追偿。同时您承诺：资金损失事实真实存在，赔偿申请材料真实、有效。您已充分知晓并认识到，基于虚假信息申请保险赔偿将涉及刑事犯罪，银联支付有权向国家有关机构申请刑事立案侦查。
		     			</p>
		     			<p>
		     				三、承诺与保证
		     			</p>
		     			<p>
		     				1、您保证使用本服务过程中提供的如姓名、身份证号、银行卡卡号及银行预留手机号等信息真实、准确、完整、有效。银联支付按照您设置的相关信息为您提供相应服务，对于因您提供信息不真实或不完整所造成的损失由您自行承担。
		     			</p>
		     			<p>
		     				2、您授权银联支付在您使用本服务期间或本服务终止后，有权保留您在使用本服务期间所形成的相关信息数据，同时该授权不可撤销。
		     			</p>
		     			<p>
		     				四、其他条款
		     			</p>
		     			<p>
		     				1、您同意，本协议适用中华人民共和国大陆地区法律。因银联支付与您就本协议的签订、履行或解释发生争议，双方应努力友好协商解决。如协商不成，银联支付和用户同意由银联支付住所地法院管辖审理双方的纠纷或争议。
		     			</p>
		     			<p>
		     				2、本协议内容包括协议正文及所有银联支付已经发布的或将来可能发布的银联支付服务的使用规则。所有规则为本协议不可分割的一部分，与协议正文具有相同法律效力。若您在本协议内容发生修订后，继续使用本服务的，则视为您同意最新修订的协议内容；否则您须立即停止使用本服务。
		     			</p>
		     			<p>
		     				3、您同意，本协议之效力、解释、变更、执行与争议解决均适用中华人民共和国法律，没有相关法律规定的，参照通用国际商业惯例和（或）行业惯例。
		     			</p>
		     			<p>
		     				4、本协议部分内容被有管辖权的法院认定为违法或无效的，不因此影响其他内容的效力。
		     			</p>
		     			<p>
		     				5、本协议未尽事宜，您需遵守银联支付网站上公布的相关服务协议及相关规则。
		     			</p>
		     		</div>
		     	</div>
		     </div>
		     <div id="loader8" style="display: none;"></div>
		</div>
		<script type="text/javascript" src="js/vue.min.js" ></script>
		<script type="text/javascript" src="js/bank.js" ></script>
		<script>
 			$(".xieyi").click(function(){
 				$(".agree_mod").show();
 			})
 			$("#yes").click(function(){
 				$(".agree_mod").hide();
 				$("#agrees").attr("checked","checked");
 			})
			//获取地址栏
	    	function UrlSearch()
				{                 
				    var name,value;
				    var str=location.href; //取得整个地址栏
				    var num=str.indexOf("?")
				    str=str.substr(num+1); //取得所有参数   stringvar.substr(start [, length ]
				    var arr=str.split("&"); //各个参数放到数组里
				    for(var i=0;i < arr.length;i++){
				        num=arr[i].indexOf("=");
				        if(num>0){
				            name=arr[i].substring(0,num);
				            value=arr[i].substr(num+1);
				            this[name]=value;
				        }
				    }
				}
				var Request=new UrlSearch(); //实例化
				var money=Request.money;
				var liqType=Request.liqType;
				var carId=Request.carId;
				var alias=Request.alias;
				var userOrder=Request.userOrder;
				var orderNo=Request.orderNo;
				var bank=Request.bank;
				var userId=Request.userId;
				var remark=Request.remark;
				//取logo
				var src="img/"+bank+".png";
				$("#logo").attr("src",src);
				//查找对应的银行名称
				for(var i=0;i<bankJson.length;i++){
                    if(bankJson[i].tag==bank){
                        $("#cardBank").html(bankJson[i].znName);
                    }
               }
				//截取卡号后四位
//				carId="6217000190003938084"
				var carEnd=carId.substring(carId.length-4,carId.length);
				$(".last_id_tit").html(carEnd);
				function toDecimal2(x){
				    var f = parseFloat(x);
				    if (isNaN(f)) {
				        return false;
				    }
				    var f = Math.round(x*100)/100;
				    var s = f.toString();
				    var rs = s.indexOf('.');
				    if (rs < 0) {
				        rs = s.length;
				        s += '.';
				    }
				    while (s.length <= rs + 2) {
				        s += '0';
				    }
				    return s;
				}
				$("#money").html(toDecimal2(money));
				$("#orders").html(userOrder);
				$(".msgFirst").hide();
				$(".msgRepeat").show();
				var timeBack=60;
				function timers(){
					timeBack=timeBack-1;
					$("#times").html(timeBack);
					if(timeBack<1){
						timeBack=0;
						clearTimeout(timer);
						$(".msgFirst").show();
						$(".msgRepeat").hide();
						$(".msgFirst").bind("click",foo);
						$(".msgFirst").css("color","#000");
					}else{
						setTimeout(timers,1000);
					}
				}
				var timer=setTimeout(timers,1000);
				
				function foo(){
						$(".msgFirst").unbind("click",foo);
						$("#loader8").css("display","block");
						$(".msgFirst").css("color","#999");
						userOrder="";
						for(var i=0;i<20;i++){
							userOrder+=Math.floor(Math.random()*10);
						}
						$("#orders").html(userOrder);
						$.ajax({
								type:"post",
								url:"http://120.55.20.13/H5pPay/Pay",
								data:{
									"userId":userId,
									"userOrder":userOrder,//随机生成20位数字,不成功时，验证码点完之后倒计时60秒，可再点
									"money":toDecimal2(money),
									"liqType":liqType,
									"remark":remark,
									"goods":"交易",
									"goodsbody":"交易",
									"closeTime":"1d",
									"carId":carId,
									"alias":alias
								},
								success:function(data){
									$("#loader8").css("display","none");
									orderNo=data.orderNo;
									console.log(data);
									$(".msgFirst").hide();
									$(".msgRepeat").show();
									var timeBack=60;
									function timers(){
										timeBack=timeBack-1;
										$("#times").html(timeBack);
										if(timeBack<1){
											timeBack=0;
											clearTimeout(timer);
											$(".msgFirst").show();
											$(".msgRepeat").hide();
											$(".msgFirst").bind("click",foo);
											$(".msgFirst").css("color","#000");
										}else{
											setTimeout(timers,1000 );
										}
									}
									var timer=setTimeout(timers,1000);
									if(data.resultData=="0000"){
										console.log("发送成功!");
									}else{
										$(".modal").css("display","block");
										$("#error").html(data.resultMsg);
										setTimeout(function(){
											$(".modal").css("display","none");
										},1200);
										
									}
								},
					            error:function(){
						            console.log("操作失败!");
								}
						})
					}
				$(".msgFirst").bind("click",foo);
				//确认支付
				$("#pay").click(function(){
					if($("#yzm_tex").val()==""){
						$(".modal").css("display","block");
						$("#error").html("请输入验证码!");
						setTimeout(function(){
							$(".modal").css("display","none");
						},1200);
					}else if(!($("#agrees").is(':checked'))){
						$(".modal").css("display","block");
						$("#error").html("支付前请阅读服务协议!");
						setTimeout(function(){
							$(".modal").css("display","none");
						},1200);
					}else{
						$("#pay").unbind('click');
						$("#loader8").css("display","block");
						$("#pay").css("background","#ff7878");
						$.ajax({
							type:"post",
							url:"http://pay.goldepay.cn/mobile/smsConfirm.do",
							data:{
								"orderNo":orderNo,
								"checkCode":$("#yzm_tex").val()	
							},
							success:function(data){
								$("#loader8").css("display","none");
								console.log(data);
								var resultMsg=data.resultMsg;
								if(data.resultCode=="0000"){
									var test=decodeURI(document.cookie.substring(5,document.cookie.length-1));
									if(test.indexOf(cardId)>=0){
										console.log("cookie中已存有该卡信息!");
									}else{
										var cdc="";
							            function setCookie(name, value) {
							                document.cookie =name+"="+value;
							            };
							            function savecookie() {
							                cdc=cdc.concat("{carId:'"+carId+"',img:'img/"+bank+".png',bankName:'"+bank+"',carEnd:'"+carEnd+"'},");
							                setCookie('test',encodeURI(cdc));
							            }
							            savecookie();
									}
									location.href="success.html?resultMsg="+resultMsg+"&money="+money;
								}else{
									location.href="fail.html?resultMsg="+resultMsg+"&money="+money;
								}
								
							},
				            error:function(){
					          console.log("操作失败!");
							}
						})
					}
				})
			$(".down").click(function(){
				$(".down").css("display","none");
				$(".up").css("display","block");
				$(".con_main_more").css("display","block");
			})
			$(".up").click(function(){
				$(".down").css("display","block");
				$(".up").css("display","none");
				$(".con_main_more").css("display","none");
			})
		</script>
	</body>
</html>
